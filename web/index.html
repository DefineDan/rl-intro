<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>RL Intro in Pyodide</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="script.js"></script>
  <script src="plot.js"></script>

</head>

<body>
  <h1>RL Intro in Pyodide</h1>
  <div x-data="gridWorld()">
    <div class="mode-toggle" style="margin-bottom: 12px; display: flex; gap: 8px;">
      <button :class="{ active: mode === GridMode.CONFIG }" @click="mode = GridMode.CONFIG">Grid Config</button>
      <button :class="{ active: mode === GridMode.VALUES }" @click="mode = GridMode.VALUES" :disabled="!agentValues">Agent Values</button>
    </div>

    <div id="gridworld" class="grid" :style="`grid-template-columns: repeat(${gridWidth}, 40px)`">
      <template x-for="(row, i) in [...grid].reverse()" :key="i">
        <template x-for="(cell, j) in row" :key="j">
          <div class="cell"
            :style="getCellStyle(cell, grid.length - 1 - i, j)"
            @click="mode === GridMode.CONFIG && updateCell(grid.length - 1 - i, j)"
            x-html="getCellContent(grid.length - 1 - i, j)">
          </div>
        </template>
      </template>
    </div>

    <template x-if="mode === GridMode.CONFIG">
      <div class="controls">
        <template x-for="(label, state) in stateLabels" :key="state">
          <button :class="{ active: selectedState === parseInt(state) }" @click="selectedState = parseInt(state)"
            x-text="label">
          </button>
        </template>
      </div>
    </template>

    <!-- Agent Configuration Form as a separate Alpine.js component -->
    <div class="agent-config" x-data="agentConfig()" x-init="window.agentConfigInstance = $data">
      <label>
        Agent Type:
        <select x-model="agentType">
          <option :value="AgentType.EXPECTED_SARSA">Expected Sarsa</option>
          <option :value="AgentType.Q_LEARNING">Q-Learning</option>
          <option :value="AgentType.SARSA">Sarsa</option>
        </select>
      </label>
      <label>
        Learning Rate:
        <input type="number" step="0.01" min="0" max="1" x-model.number="learningRate" />
      </label>
      <label>
        Discount:
        <input type="number" step="0.01" min="0" max="1" x-model.number="discount" />
      </label>
      <label>
        Epsilon:
        <input type="number" step="0.01" min="0" max="1" x-model.number="epsilon" />
      </label>
    </div>
    <!-- End Agent Configuration Form -->

    <button @click="confirmGrid()">Confirm Grid</button>
    <button @click="step()">Step</button>
    <button @click="run()">Run</button>
    <button @click="pause()">Pause</button>
    <button @click="reset()">Reset</button>
    <button @click="runFullAnalysis()">Run Full Analysis</button>

    <div class="speed-control">
      <label for="speed-slider">Speed</label>
      <input id="speed-slider" type="range" min="10" max="500" step="10" x-model="stepDelay"
        @input="if (isRunning) run()" />
      <span x-text="stepDelay + ' ms'"></span>
    </div>

    <div style="display: flex; flex-direction: row; gap: 24px; align-items: flex-start;">
      <div id="reward-plot"></div>
      <div id="episodic-reward-plot"></div>
    </div>
    <pre id="output">Loading...</pre>
    <div id="value-heatmap"></div>
  </div>
</body>

</html>